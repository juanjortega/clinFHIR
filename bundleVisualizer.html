<!DOCTYPE html>
<html>
<head lang="en">
    <base href="/" />

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YD055VEN8K"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-YD055VEN8K');
    </script>

    <meta charset="UTF-8">
    <script src="js/libs/jquery-1.9.0.min.js"></script>
    <script src="js/libs/angular.min1-5.js"></script>
    <script src="js/libs/ui-bootstrap-tpls-2.0.1.min.js"></script>

    <script src="js/libs/moment.min.js"></script>
    <link rel="stylesheet" type="text/css" href="css/jsTreeStyle.css"/>
    <link rel="stylesheet" type="text/css" href="css/jsTreeThemes/proton/style.css"/>

    <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css"/>
    <link rel="stylesheet" type="text/css" href="css/main.css"/>
    <link rel="stylesheet" type="text/css" href="css/vis.min.css"/>

    <script src="js/libs/angular-sanitize.js"></script>
    <script src="js/libs/firebase.js"></script>
    <script src="js/libs/angularfire.min.js"></script>

    <script src="js/libs/jstree.min.js"></script>
    <script src="js/libs/vkbeautify.0.99.00.beta.js"></script>

    <script src="js/libs/fhirpath.min.js"></script>

<!--
<script src="js/libs/angular-sanitize.js"></script>
    <script src="js/libs/handlebars-v4.1.2.js"></script>
    -->



    <style>
        .popover-content {
            max-width: 400px;
        }

        .resourceType {
            border: 1px solid darkgrey; padding: 2px;
        }
    </style>


    <script>
        angular.module("sampleApp",['ui.bootstrap','ngStorage','firebase','ngSanitize','ui.checkbox']).config(function($locationProvider) {
            $locationProvider.html5Mode(true);
            $locationProvider.hashPrefix('!');
        });
        angular.module("sampleApp").constant("moment", moment);

    </script>

    <script src="js/loginCtrl.js"></script>
    <script src="js/bundleVisualizerCtrl.js"></script>
    <script src="js/v2ToFhirSvc.js"></script>
    <script src="js/libs/vis.min.js"></script>
    <script src="js/modalDialogSvc.js"></script>
    <script src="resourceBuilder/rbServices.js"></script>
    <script src="js/libs/angular-bootstrap-checkbox.js"></script>

    <script src="js/bundleVisualizerSvc.js"></script>
    <script src="js/serverInteractionSvc.js"></script>

    <style>
        .myForm {
            padding: 8px;
        }
        .modelScroll {
            height: 500px;
            overflow-y: scroll;
        }
        .entryListScroll {
            height: 500px;
            overflow-y: scroll;
        }
        #resourceGraph {
            width: 100%;
            height: 550px;
            border: 1px solid lightgray;
        }

        #canonicalGraph {
            width: 100%;
            height: 550px;
            border: 1px solid lightgray;
        }


        #singleResourceGraph {
            width: 100%;
            height: 550px;
            border: 1px solid lightgray;
        }

        table {
            border-collapse: collapse;
        }

        table, th, td {
            border: 1px solid black;
            padding: 5px;
        }

        th {
            font-weight: bold;
        }
        thead {
            font-weight: bold;
        }
        .error {
            color: red;
        }
        .warning {
            color: #ec971f;
        }

    </style>

    <script src="js/modalDialogSvc.js"></script>
    <script src="js/appConfigSvc.js"></script>
    <script src="js/libs/ngStorage.min.js"></script>
    <script src="js/filters.js"></script>
    <script src="js/bundleVisualizerCtrl.js"></script>

    <title>Bundle Visualizer</title>

</head>


<body style="padding: 8px;padding-top: 80px" >

<div ng-app="sampleApp" ng-controller="bundleVisualizerCtrl" class="container-fluid">

    <nav class="navbar navbar-default navbar-fixed-top" role="navigation">

        <div class="container-fluid">
            <div class="col-md-2 ">
                <span>
                    <a class="navbar-brand" href="#" ng-click="showVersion()">
                        Bundle Visualizer
                    </a>
                </span>

            </div>
            <div class="col-md-2">
                <div class="navbar-text">
                    <div ng-hide = "showSelector || urlPassedIn" class="clickable" ng-click="showSelector = true">Show Selector</div>
                </div>
            </div>


            <div class="col-md-2">

            </div>


            <div class="col-md-1">

            </div>


            <div class="col-md-1">
                <form class="navbar-form navbar-left">
                    <img ng-show="waiting" src="css/ajax_loader_blue_32.gif"/>
                </form>
            </div>


            <div class="col-md-1 col-sm-1">


            </div>



            <div class="col-md-3">
                <div class="pull-right">
                    <a href="https://www.intersystems.com/" target="_blank">
                        <img style="padding-top: 8px;padding-bottom: 8px" src="/icons/sb-intersystems.png"/>
                    </a>

                </div>

            </div>

        </div>
    </nav>

    <div ng-show = "showSelector">

        <uib-tabset>
            <uib-tab>
                <uib-tab-heading>
                    Home
                </uib-tab-heading>

                <div class="row">

                    <div class="col-md-6">

                        <h4>Description</h4>

                        <p>Displays the contents of a FHIR Bundle in a number of different visualizations.</p>

                        There are 2 ways to specify the bundle:
                        <ul>
                            <li>By entering a query url that will return a Bundle. Generally this will be to
                            a FHIR server, but it can be any Bundle accessible via HTTP. Url's can be saved in
                            the browser cache for easy access if needed. Saved queries are in the list to the
                            right, use the 'enter query' tab above to enter a new one</li>
                            <li>You can paste a bundle directly into the tab above - either Json or XML is
                            supported.</li>
                        </ul>

                        <br/>
                        <h4>Configuration</h4>

                        <div><strong>Data server:</strong> {{dataServer.name}} ({{dataServer.url}}) <span class="clickable" ng-click="changeServer('data')">Change</span> </div>
                        <br/>

                        <p>The data server is the 'default' server when creating a query. You can however specify any server you want by using the
                            full url when creating the query.</p>

                        <br/>



                        <h4>Validation options</h4>

                        <strong>Validation server:</strong>

                        {{validationServer.name}} ({{validationServer.url}})
                        <span class="clickable" ng-click="changeServer('validation')">Change</span>
                        <br/><br/>
                        <p>Used when validating the bundle and its contents. This occurs automatically when a bundle is
                            processed and displayed, unless disabled using the otion below. </p>
                        <br/>

<!--
                        <div>
                            <checkbox ng-model="localStorage.bvConfig.noValidate"></checkbox>
                            Don't validate.
                        </div>

                        -->
<!--
                        <div>
                            <checkbox ng-model="localStorage.bvConfig.setValidate"></checkbox>
                            Set validation server to the same server as the url.
                        </div>
-->




                    </div>

                    <div class="col-md-6">


                        <h4>Saved queries</h4>
                        <table class="table table-bordered">
                            <tr ng-repeat = "item in savedQueries">
                                <td>
                                    <div class = 'clickable' ng-click="executeSavedQuery(item)">{{item.name}}</div>
                                </td>
                                <td>{{item.qry}}</td>
                                <td><i class="glyphicon glyphicon-remove-sign clickable" ng-click="deleteQuery($index)"></i>
                                </td>
                                <!--
                                <td width="80"><button class="btn btn-link" ng-click="executeSavedQuery(item)">Load</button> </td>
                                -->
                            </tr>
                        </table>


                        <div>
                            <em>Queries are saved in the local browser cache</em>
                        </div>



                    </div>

                </div>



            </uib-tab>


            <uib-tab heading = "Paste in bundle">
                <div class="row">
                    <div class="col-md-4">
                        <br/>
                        <p>Paste a bundle into the text area to the right. </p>
                        <p>Click the 'View bundle' button (that will appear) to start the Visualizer.</p>
                        <p>Either Json or XML can be used. XML will be converted to Json (using the <a href="https://github.com/lantanagroup/FHIR.js">Lantana</a> library) before
                        being displayed.</p>

                        <button ng-show = "input.newBundle" class="btn btn-success"
                                ng-click="viewNewBundle(input.newBundle)">View bundle</button>


                    </div>
                    <div class="col-md-8">
                        <textarea class="form-control" rows = '20' ng-model="input.newBundle"></textarea>
                    </div>

                </div>


            </uib-tab>
            <uib-tab heading = "Enter query url">
                <br/>

                <div class="row">
                    <div class="col-md-6">
                        <p>Enter a query that returns a FHIR bundle</p>
                        <p>The query can be to a FHIR server or standard server (like a bundle stored in Github)</p>
                        <p>You can use the currently configured data server (<strong>{{dataServer.url}}</strong>) or any other server. To specify another server
                            simply use the full url - eg http://myserver/mybundle. If you leave off the 'http' the app will assume
                            you are making standard <a href="http://hl7.org/fhir/http.html#search" target="_blank">FHIR query</a> (Only a GET is supported)</p>
                        <p>You can change the configured server <span class="clickable" ng-click="changeServer('data')">here.</span> </p>
                        <p>If you want to save the query (so it will appear in your personal list, you need to specify
                            a name in the box below and click the 'Add query to list' button that appears after testing
                            the query.</p>

                        <!--
                        <label>Data server url</label>
                        <div>{{dataServer.url}}</div>
                        -->
                        <br/><br/>
                        <label>Query to execute</label>
                        <textarea class="form-control" ng-model="input.newQuery" placeholder="The query."></textarea>
                        <span class="help-block pull-right">Use full query (incl. http) if to a different server</span>

                        <br/><br/>
                        <label>Query name</label>
                        <div>
                            <input class="form-control" ng-model="input.newQueryName" placeholder="A name for the query (required if query is to be saved"/>
                        </div>
                        <span class="help-block pull-right">Required if the query is to be saved</span>
                        <br/><br/>

                        <div>
                            <button ng-show = "input.newQuery && ! testQueryBundle" class="btn btn-primary"
                                    ng-click="testNewQuery(input.newQuery)">Test query</button>

                            <button ng-show = "executedQueryBundle" class="btn btn-warning"
                                    ng-click="clearQuery()">Clear</button>

                            <button ng-show = "executedQueryBundle && input.newQueryName" class="btn btn-danger"
                                    ng-click="addNewQuery(input.newQuery,input.newQueryName)">Add query to list and view</button>

                            <button ng-show = "executedQueryBundle" class="btn btn-success"
                                    ng-click="viewNewQueryBundle(executedQueryBundle)">View bundle</button>
                        </div>

                        <br/>
                        <strong ng-show="executedQuery">Executed query</strong>
                        <div>{{executedQuery}}</div>
                    </div>
                    <div class="col-md-6">
                        <pre>{{executedQueryBundle | json}}</pre>
                    </div>



                </div>
            </uib-tab>

            <uib-tab heading = "Examples">
                <br/>
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-bordered">
                            <tr ng-repeat="example in exampleIndex.contents">
                                <td><div class="clickable" ng-click="selectExample(example)">{{example.name}}</div></td>
                                <td>{{example.display}}</td>

                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="clickable" ng-click="loadExample(exampleBundle)">Load</div>
                            </div>
                        </div>
                        <pre>{{exampleBundle | json}}</pre>

                    </div>
                </div>

            </uib-tab>

        </uib-tabset>

    </div>

    <div ng-hide = "showSelector" class="row">

        <div ng-class="col-md-12">
         <!--   <div ng-class="rightPaneClass">-->

            <div ng-show="!fhir || input.showHelp">
                <br/>
                <strong>Adding a bundle to view</strong>
                <br/> <br/>
                The left pane allows 2 ways to add a bundle to the visualizer.
                <ul>
                    <li>A bundle can be pasted in directly by clicking the 'Import Bundle'.
                        Json bundles are processed directly. XML bundles are saved to the Data server, and then retrieved as Json.
                        In either case the bundle can be saved to the bundle list by supplying an identifier.</li>
                    <li>A query can be entered that will call the REST API of a server to return the bundle. The format
                        must be Json and the server must support CORS.</li>
                </ul>



                <strong>Strategy for determining references between resources</strong>
                <br/> <br/>
                <ul>
                    <li>If an entry has a fullUrl (preferred), then this will become the id of the resource from the
                        perspective of a reference target. Otherwise
                        the data server root, resource type and resource id are combined to make an absolute url to act as the id </li>
                    <li>If a reference is relative, it is combined with the server root to make it absolute.</li>
                </ul>

                <a href="https://docs.google.com/document/d/1bwyRKU100m8VOM30bcR_6bUms8FaC13SMrPAK5o6IR8/edit#" target="_blank">Link to on-line docs</a>
            </div>


                    <div>

                        <button class="btn btn-link pull-right" ng-show="fhir"
                                ng-click="performValidation()">Validate</button>


                        <button class="btn btn-link pull-right" ng-show="fhir"
                                ng-click="copyToClipboard()">Copy bundle to Clipboard</button>

                    </div>

                    <uib-tabset active="setTab.mainTabActive" ng-show="fhir" >

                        <uib-tab>
                            <br/>
                            <uib-tab-heading>
                                Bundle entries <span class="badge">{{fhir.entry.length}}</span>
                            </uib-tab-heading>



                            <div class="row">
                                        <div class="col-md-3">

                                            <uib-tabset>
                                                <uib-tab heading="Bundle Order">

                                                    <div class="entryListScroll">


                                                        <div class="list-group">
                                                            <div ng-class="{'list-group-item':true,'listItemSelected':selectedBundleEntry == entry}" ng-repeat="entry in fhir.entry"
                                                                 ng-click="selectBundleEntry(entry,hashErrors[$index])">

                                                                <strong>{{entry.resource.resourceType}}</strong>

                                                                <span class="pull-right badge">{{hashErrors[$index].length}}</span>
                                                                <div>{{entry.resource.text.div | cleanTextDiv | limitTo:50}}</div>
<!--
                                                                <div><em>{{entry.fullUrl}}</em></div>
                                                                -->
                                                                <div style="padding-left: 10px"><em>Id: {{entry.resource.id}}</em></div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                </uib-tab>


                                                <uib-tab heading="Type, Id">
                                                    <div class="entryListScroll">
                                                        <div ng-repeat="es in sortedEntries">
                                                            <strong>{{es.type}}</strong>
                                                            <div class="list-group">
                                                                <div ng-repeat = "entry in es.entries"
                                                                     ng-class="{'list-group-item':true,'listItemSelected':selectedBundleEntry == entry}">
                                                                    <div style="padding-left: 10px; cursor: pointer"
                                                                         ng-click="selectBundleEntry(entry,[])">
                                                                        <div> {{entry.resource.text.div | cleanTextDiv | limitTo:50}}</div>
                                                                        <div style="padding-left: 10px"><em>Id: {{entry.resource.id}}</em></div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>

                                                    </div>
                                                </uib-tab>

                                                <uib-tab heading="Type, Name">
                                                    <div class="entryListScroll">
                                                        <div ng-repeat="(k,v) in hashByName">
                                                            <div><strong>{{k}}</strong></div>


                                                            <div class="list-group">
                                                                <div class="list-group-item" ng-repeat="item in v"
                                                                     ng-click="selectBundleEntry(item.entry,hashErrors[$index])">
                                                                    {{item.display}}
                                                                </div>
                                                            </div>


                                                        </div>
                                                    </div>
                                                </uib-tab>

                                                <uib-tab heading="Type">

                                                    <div class="list-group">
                                                        <div class="list-group-item" ng-repeat = "es in sortedEntries">
                                                            {{es.type}}
                                                        </div>
                                                    </div>

                                                </uib-tab>

                                            </uib-tabset>



                                        </div>

                                        <div class="col-md-9">

                                            <div class="pull-right">
                                                <a target="_blank"
                                                   ng-show="selectedBundleEntry"
                                                   ng-href="http://hl7.org/fhir/{{selectedBundleEntry.resource.resourceType}}.html#resource">{{selectedBundleEntry.resource.resourceType}} in the Spec</a>
                                            </div>

                                            <uib-tabset>
                                                <uib-tab heading="Json">
                                                    <pre>{{selectedBundleEntry.resource | json}}</pre>
                                                </uib-tab>
                                                <uib-tab heading="Entry">
                                                    <pre>{{selectedBundleEntry | json}}</pre>
                                                </uib-tab>

                                                <uib-tab heading="Text">
                                                    <p ng-bind-html="selectedBundleEntry.resource.text.div"></p>


                                                </uib-tab>


                                                <uib-tab heading="Tree">
                                                    <br/>

                                                    <div id="builderResourceTree"></div>

                                                </uib-tab>

                                                <uib-tab heading="References"  select="fitSingleGraph()">
                                                    <br/>
                                                    <div class="row">
                                                        <!--
                                                        <div class="col-md-3">
                                                            <div uib-popover="If checked will include all resources that have a reference to the selected one."
                                                                 popover-placement="top"
                                                                 popover-trigger="'mouseenter'">
                                                                Show inward references <checkbox ng-model="input.showInRef" ng-change="createGraphOneEntry()"></checkbox>
                                                            </div>

                                                        </div>
                                                        <div class="col-md-3">
                                                            <div uib-popover="If checked will include all resources that are references by the selected one."
                                                                 popover-placement="top"
                                                                 popover-trigger="'mouseenter'">
                                                                Show outward references <checkbox ng-model="input.showOutRef" ng-change="createGraphOneEntry()"></checkbox>
                                                            </div>

                                                        </div>
                                                        <div class="col-md-3">
                                                            <div  uib-popover="If checked will include all resources connected to the selected resource, and all references between them."
                                                                  popover-placement="top"
                                                                  popover-trigger="'mouseenter'">
                                                                Recursive references <checkbox ng-model="input.recursiveRef" ng-change="createGraphOneEntry()"></checkbox>

                                                            </div>
                                                        </div>
-->
                                                        <div class="col-md-3">
                                                            <div  uib-popover="If checked will hide the Patient resource."
                                                                  popover-placement="top"
                                                                  popover-trigger="'mouseenter'">
                                                                Hide Patient <checkbox ng-model="input.showHidePatient" ng-change="createGraphOneEntry()"></checkbox>

                                                            </div>
                                                        </div>

                                                    </div>
                                                    <br/>

                                                    <div class="row">
                                                        <div class="col-md-7 col-sm-7">
                                                            <div id="singleResourceGraph"></div>
                                                        </div>
                                                        <div class="col-md-5 col-sm-5">
                                                            <button class="btn btn-link pull-right"
                                                                    ng-show="selectedFromSingleGraph"
                                                                    ng-click="selectFromSingleGraph()">Select {{selectedFromSingleGraph.resourceType}}</button>
                                                            <uib-tabset>
                                                                <uib-tab heading="Json">
                                                                    <pre>{{selectedFromSingleGraph | json}}</pre>
                                                                </uib-tab>
                                                                <uib-tab ng-show="selectedFshFromSingleGraph" heading="Fsh">
                                                                    <pre>{{selectedFshFromSingleGraph}}</pre>
                                                                </uib-tab>

                                                                <uib-tab ng-show="selectedFromSingleGraph.resourceType == 'DiagnosticReport'" heading="DiagnosticReport">
                                                                    <br/>
                                                                    <div class="banner">Observations referenced from this DiagnosticReport</div>
                                                                    <div ng-repeat="item in DR" ng-show="item.DR.id == selectedFromSingleGraph.id">
                                                                        <table class="table-bordered table">
                                                                            <tr ng-repeat = "obs in item.obs">
                                                                                <td>
                                                                                    <div class="clickable" ng-click="selectFromSingleGraph(obs)">
                                                                                        {{obs.text.div | cleanTextDiv}}
                                                                                    </div>

                                                                                </td>
                                                                                <td>
                                                                                    {{obs.valueCodeableConcept.text}} {{obs.valueString}}   {{obs.valueQuantity.value}}
                                                                                </td>
                                                                            </tr>
                                                                        </table>



                                                                    </div>
                                                                </uib-tab>

                                                            </uib-tabset>



                                                        </div>
                                                    </div>

                                                </uib-tab>

                                                <uib-tab ng-show="selectedBundleEntry.resource.resourceType == 'Binary'" heading="Binary Content">
                                                    <br/>
                                                    <pre>{{base64Decode(selectedBundleEntry.resource.data)}}</pre>


                                                </uib-tab>

                                                <uib-tab ng-show="selectedBundleEntryErrors.length > 0">
                                                    <uib-tab-heading>
                                                        Errors <span class="badge">{{selectedBundleEntryErrors.length}}</span>
                                                    </uib-tab-heading>
                                                    <br/>
                                                    <div>
                                                        <em class = "pull-right">Validation Server: {{validationServer.url}}</em>
                                                    </div>

                                                    <div uib-alert class="alert-warning">
                                                        <table class="table">
                                                            <tr ng-repeat="err in selectedBundleEntryErrors">
                                                                <td>{{err.severity}}</td>
                                                                <td>
                                                                    {{err.diagnostics}}
                                                                    {{err.details.text}}
                                                                    <div ng-repeat = "ex in err.expression">
                                                                        {{ex}}
                                                                    </div>
                                                                </td>
                                                                <td>
                                                                    <div ng-repeat="location in err.location">
                                                                        {{location}}
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                        </table>
                                                    </div>

                                                    <br/>
                                                    <div><strong>Notes</strong></div>
                                                    <ul>

                                                        <li>
                                                            "Resource should have narrative..." means you're missing the .text element
                                                        </li>

                                                        <li>"Unable to resolve resource..." errors simply mean that the referenced
                                                        resource was not found on the Validation server. These can generally be ignored.</li>
                                                    </ul>
                                                </uib-tab>

                                                <uib-tab ng-show="fshText" heading="FSH (transformed)">
                                                    <pre>{{fshText}}</pre>
                                                </uib-tab>

                                                <uib-tab ng-show="xmlText"  heading="XML (transformed)">
                                                    <pre>{{xmlText}}</pre>
                                                </uib-tab>

                                                <uib-tab ng-show="selectedBundleEntry.resource.resourceType == 'Composition'" heading="Sections"  >


                                                    <div class="col-md-6 col-sm-6">

                                                        <div ng-repeat="section in selectedBundleEntry.resource.section">
                                                            <strong>{{section.title}}</strong>


                                                            <div class="list-group">



                                                                <div ng-class="{'list-group-item':true,'listItemSelected':entry.reference == selectedRef}"
                                                                     ng-repeat="entry in section.entry">
                                                                    <div class="clickable" ng-click="selectResourceFromSection(entry.reference)">
                                                                        {{entry.reference}}</div>


                                                                </div>
                                                            </div>


                                                        </div>

<!--
                                                        <table class="table table-bordered">
                                                            <tr><th>Title</th><th>References</th></tr>
                                                            <tr ng-repeat="section in selectedBundleEntry.resource.section">
                                                                <td>{{section.title}}</td>
                                                                <td>

                                                                    <div ng-repeat="entry in section.entry">
                                                                        <div class="clickable" ng-click="selectResourceFromSection(entry.reference)">
                                                                            {{entry.reference}}</div>
                                                                    </div>
                                                                </td>


                                                            </tr>
                                                        </table>
-->


                                                    </div>
                                                    <div class="col-md-6 col-sm-6">
                                                        <pre>{{resourceFromSection | json}}</pre>
                                                    </div>

                                                </uib-tab>

                                                <uib-tab ng-show="selectedBundleEntry.resource.resourceType == 'ValueSet' && selectedBundleEntry.resource.expansion">

                                                    <uib-tab-heading>
                                                        Expansion <span class="badge">{{selectedBundleEntry.resource.expansion.contains.length}}</span>
                                                    </uib-tab-heading>

                                                    <table class="table table-condensed">
                                                        <tr ng-repeat = "concept in selectedBundleEntry.resource.expansion.contains">
                                                            <td>
                                                                {{concept.code}}
                                                                <div>{{concept.system}}</div>
                                                                <div>{{concept.version}}</div>
                                                            </td>
                                                            <td>{{concept.display}}</td>
                                                        </tr>
                                                    </table>
                                                </uib-tab>

                                                <uib-tab ng-show="hashRefsByResource[selectedBundleEntry.resource.id].length > 0">
                                                    <uib-tab-heading>
                                                        Canonicals <span class="badge">{{hashRefsByResource[selectedBundleEntry.resource.id].length}}</span>

                                                    </uib-tab-heading>

                                                    <pre>{{hashRefsByResource[selectedBundleEntry.resource.id] | json}}</pre>

                                                </uib-tab>

                                            </uib-tabset>
                                        </div>

                                    </div>


                        </uib-tab>


                        <uib-tab heading = "References Graph" select="fitGraph()">

                            <div class="alert alert-warning" ng-show="showGraphWarning">
                                Large graphs can take a while to render in the graph. Be patient!
                            </div>

                            <div class="row">
                                <div class="col-md-8">

                                    <div>
                                        <div class="pull-right">
                                            <input ng-model="input.showHidePatient" type="checkbox"
                                                   ng-click="showHidePatient(input.showHidePatient)"/> Hide Patient
                                        </div>
                                    </div>


                                    <div id="resourceGraph"></div>
                                </div>
                                <div class="col-md-4">

<!-- todo - selectedBundleEntryErrors not being created on graph select-->
                                    <!--
                                    <div uib-alert class="alert-warning" ng-show="selectedBundleEntryErrors.length > 0">
                                        <table class="table">
                                            <tr ng-repeat="err in selectedBundleEntryErrors">
                                                <td>{{err.severity}}</td>
                                                <td>{{err.diagnostics}}</td>
                                                <td>
                                                    <div ng-repeat="location in err.location">
                                                        {{location}}
                                                    </div>
                                                </td>
                                            </tr>
                                        </table>
                                    </div>

                                    -->

                                    <div class="pull-right">
                                        <button class="btn btn-link"
                                                ng-click="selectFromMainGraph(selectedNode.entry.resource)">Details</button>
                                    </div>

                                    <uib-tabset>
                                        <uib-tab heading="Resource">
                                            <pre>{{selectedNode.entry.resource | json}}</pre>
                                        </uib-tab>
                                        <uib-tab heading="Entry">
                                            <pre>{{selectedNode.entry | json}}</pre>
                                        </uib-tab>

                                        <uib-tab ng-show="selectedNode.entry.resource.resourceType == 'DiagnosticReport'" heading="DiagnosticReport">
                                            <br/>
                                            <div class="banner">Observations linked to this DiagnosticReport</div>

                                            <div ng-repeat="item in DR" ng-show="item.DR.id == selectedNode.entry.resource.id">
                                                <table class="table-bordered table">
                                                    <tr ng-repeat = "obs in item.obs">
                                                        <td>
                                                            {{obs.text.div | cleanTextDiv}}
                                                            <div ng-repeat="coding in obs.code.coding">
                                                                {{coding.display}}
                                                            </div>
                                                        </td>
                                                        <td>
                                                            {{obs.valueCodeableConcept.text}} {{obs.valueString}} {{obs.valueQuantity.value}}
                                                            {{obs.valueQuantity.unit}}

                                                        </td>

                                                    </tr>
                                                </table>

                                            <!--
                                                <div ng-repeat = "obs in item.obs">
                                                    <strong>{{obs.text.div | cleanTextDiv}}</strong>
                                                    <div style="margin-left: 8px">{{obs.valueCodeableConcept.text}} {{obs.valueString}}   {{obs.valueQuantity.value}}</div>
                                                </div>
                                                -->

                                            </div>

                                        </uib-tab>

                                    </uib-tabset>



                                </div>
                            </div>

                        </uib-tab>

                        <uib-tab heading = "Canonical graph"  select="fitSingleGraph()">
                            <div class="row">
                                <div class="col-md-7">
                                    <div class="row">

                                        <div class="col-md-12">
                                            <button class="btn btn-link pull-right" ng-click="fitCanonicalGraph()">Refresh graph (if no display)</button>
                                        </div>
                                    </div>
                                    <div id="canonicalGraph"></div>
                                </div>
                                <div class="col-md-5">
                                    <uib-tabset>
                                        <uib-tab heading="Json">
                                            <pre>{{selectedCanResource | json}}</pre>
                                        </uib-tab>
                                        <uib-tab ng-show="selectedCanResource.resourceType == 'ValueSet' && selectedCanResource.expansion">

                                            <uib-tab-heading>
                                                Expansion <span class="badge">{{selectedCanResource.expansion.contains.length}}</span>
                                            </uib-tab-heading>

                                            <table class="table table-condensed">
                                                <tr ng-repeat = "concept in selectedCanResource.expansion.contains">
                                                    <td>
                                                        {{concept.code}}
                                                        <div>{{concept.system}}</div>
                                                        <div>{{concept.version}}</div>
                                                    </td>
                                                    <td>{{concept.display}}</td>
                                                </tr>
                                            </table>
                                        </uib-tab>

                                        <uib-tab ng-show="hashRefsByResource[selectedCanResource.id].length > 0">
                                            <uib-tab-heading>
                                                Canonicals <span class="badge">{{hashRefsByResource[selectedCanResource.id].length}}</span>

                                            </uib-tab-heading>

                                            <pre>{{hashRefsByResource[selectedCanResource.id] | json}}</pre>

                                        </uib-tab>
                                    </uib-tabset>
                                </div>
                            </div>

                        </uib-tab>

                        <uib-tab ng-show="false" heading="Deep validation">
                            <br/>
                            <button class="btn btn-primary pull-right" ng-click="deepValidate()">Perform validation</button>


                            <div ng-hide="deepValidationResult">
                                <br/>
                                The deep validation will save all the resources in the bundle to the Validation Server
                                ( <strong>{{validationServer.url}}</strong> ) and then validate the entire bundle.
                                <br/> <br/>
                                <em>
                                In some cases, the server might not save
                                a resource if it has a reference to a resource that has not been saved. In that case,
                                simply repeat the 'Perform Validation' step (you may need to do this multiple times)
                                and eventually all resources will be saved)
                                </em>
                                <br/>
                                <br/>
                                Todo: change to allow a transaction as update as well (if the server supports it)
                            </div>



                            <uib-tabset ng-show="deepValidationResult">
                                <uib-tab heading="OO">
                                    <pre>{{deepValidationResult | json}}</pre>
                                </uib-tab>
                                <uib-tab heading="Table">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <div class="modelScroll">
                                                <table class="table table-condensed table-bordered">
                                                    <tr ng-repeat="iss in deepValidationResult.issue"
                                                        style="cursor: pointer"
                                                        ng-click="selectFromDeepValidate(iss)">

                                                        <td>
                                                            <div ng-class="{error:iss.severity == 'error',warning:iss.severity == 'information'}">
                                                                {{iss.diagnostics}}</div>
                                                        </td>
                                                        <td>
                                                            <div ng-repeat="loc in iss.location">
                                                                {{loc}}
                                                            </div>
                                                        </td>
                                                    </tr>
                                                </table>
                                            </div>

                                        </div>
                                        <div class="col-md-4">
                                            <pre>{{selectedDeepValidationEntry | json}}</pre>
                                        </div>
                                    </div>


                                </uib-tab>
                            </uib-tabset>





                        </uib-tab>

                        <uib-tab heading="DiagnosticReport" ng-show="DR.length > 0">
                            <ng-include src = "'includes/bvDiagnosticReport.html'"></ng-include>
                        </uib-tab>

                        <uib-tab heading="CarePlan view" ng-show="false && CarePlans.length > 0">
                            <pre>{{cpSummary | json}}</pre>
                        </uib-tab>

                        <uib-tab ng-show = "false || fhir.type == 'document'" heading="Inferno">
                            <br/>
                            <button class="btn btn-primary pull-right" ng-click="validateWithInferno()">Perform validation</button>


                            <div ng-show="validatingWithInferno">
                                Calling the Inferno API - please be patient!
                                <br/><br/>
                            </div>

                            <div ng-show="infernoError">
                                Oops, there was an error from inferno (likely a timeout)
                                <pre>{{infernoError | json}}</pre>
                            </div>

                            <div ng-hide="infernoValidationResult">

                                <p>This function will call the Inferno API to perfrom validation.</p>
                                <p>Note that this is an experimental feature so may not be correct or
                                may fail (currently it seems to be timing out on large documents</p>
                                <br/>
                                <br/>

                            </div>



                            <uib-tabset ng-show="infernoValidationResult">
                                <uib-tab heading="Table">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <div class="modelScroll">
                                                <table class="table table-condensed table-bordered">
                                                    <tr ng-repeat="iss in infernoValidationResult.issue"
                                                        style="cursor: pointer"
                                                        ng-click="selectFromInfernoValidate(iss)">

                                                        <td>
                                                            <div ng-class="{error:iss.severity == 'error',warning:iss.severity == 'information'}">
                                                                {{iss.details.text}}</div>
                                                        </td>
                                                        <td>

                                                            <div ng-repeat="exp in iss.expression">
                                                                {{exp}}
                                                            </div>
                                                        </td>
                                                    </tr>
                                                </table>
                                            </div>

                                        </div>
                                        <div class="col-md-4">
                                            <div ng-repeat="src in selectedInfernoValidationEntry">
                                                <pre>{{src | json}}</pre>
                                            </div>

                                        </div>
                                    </div>


                                </uib-tab>
                                <uib-tab heading="OO">
                                    <pre>{{infernoValidationResult | json}}</pre>
                                </uib-tab>

                            </uib-tabset>





                        </uib-tab>

                        <uib-tab ng-show = "fhir.type == 'document'" heading="Document">

                            <uib-tabset>
                                <uib-tab heading="Rendering">
                                    <strong>Subject</strong>
                                    <p  style="margin-left: 10px" ng-bind-html="document.subject.text.div"></p>

                                    <strong>Document metadata</strong>
                                    <p  style="margin-left: 10px" ng-bind-html="document.composition.text.div"></p>

                                    <div ng-repeat = "section in document.composition.section">
                                        <hr style="border-top: 1px solid grey; margin: 1px"/>
                                        <strong>{{section.title}}</strong>

                                        <div class="row">

                                            <div class="col-md-8">
                                                <p style="margin-left: 10px" ng-bind-html="to_trusted(section.text.div)"></p>
                                                <!-- <p style="margin-left: 10px" ng-bind-html="section.text.div"></p> -->

                                            </div>
                                            <div class="col-md-3">

                                                <div ng-repeat = "resource in section.realResources"
                                                     ng-click="selectResourceFromRender(resource)">
                                                    <div class="rounded-box">
                                                        {{resource.display}}

                                                        <em><p ng-bind-html="resource.resource.text.div"></p></em>
                                                    </div>
                                                </div>
                                            </div>


                                        </div>





                                    </div>

                                    <div><em>Derived from the Composition and Subject text elements as per the spec</em></div>

                                </uib-tab>
                                <uib-tab heading="By Section">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <div class="list-group">
                                                <div ng-class="{'list-group-item':true}"
                                                     ng-repeat = "section in document.composition.section"
                                                    ng-click="selectSection(section)">
                                                    {{section.title}}
                                                    <div class="pull-right badge">{{section.entry.length}}</div>
                                                    <div>{{section.code.coding[0].system}} {{section.code.coding[0].code}}</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">

                                            <table>
                                                <div class="list-group">
                                                    <div class="list-group-item" ng-repeat = "entry in selectedSection.entry">
                                                        <div ng-click="selectEntryFromSection(entry) ">{{entry.reference}}</div>
                                                    </div>
                                                </div>

                                            </table>

                                        </div>
                                        <div class="col-md-6">
                                            <pre>{{selectedEntryFromSection | json}}</pre>
                                        </div>
                                    </div>


                                </uib-tab>
                            </uib-tabset>


                        </uib-tab>

                        <uib-tab heading = "Observations">
                            <div class="row">
                                <div class="col-md-3">
                                    <strong>Observation Codes</strong>
                                    <div class="list-group">
                                        <div class="list-group-item"
                                             ng-click="selectObservationCode(hashObservations[k])"
                                             ng-repeat="(k,v) in hashObservations">

                                            <div class="pull-right badge">
                                                {{v.resources.length}}
                                            </div>
                                            <div>{{v.code.display}}</div>
                                            <div>{{v.code.code}} </div>

                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-5">
                                    <strong>{{selectedObservations[0].code.coding[0].code}} {{selectedObservations[0].code.coding[0].display}}</strong>
                                    <table class="table-bordered table">
                                        <tr>
                                            <th>Date</th><th>Age</th><th>Result</th><th>Reference Range</th>
                                        </tr>
                                        <tr ng-repeat="obs in selectedObservations"
                                            ng-click="selectObservation(obs)">
                                            <td>
                                                {{moment(obs.effectiveDateTime).format('YYYY-MM-DD')}}



                                                {{obs.effectivePeriod.start}} {{obs.effectivePeriod.end}}
                                            </td>
                                            <td>{{obs.effectiveDateTime | getAgeSeconds}}</td>
                                            <td>{{obs.valueString}}

                                                <div ng-repeat="coding in obs.valueCodeableConcept.coding">
                                                    {{coding.system}} {{coding.code}}
                                                    {{coding.display}}
                                                </div>
                                                {{obs.valueCodeableConcept.text}}

                                                {{obs.valueQuantity.value}} {{obs.valueQuantity.unit}}


                                            </td>
                                            <td>
                                                <div ng-repeat = "rr in obs.referenceRange">
                                                    {{rr.text}}
                                                </div>

                                            </td>
                                        </tr>
                                    </table>

                                </div>
                                <div class="col-md-4">
                                    <strong>Selected Observation</strong>
                                    <pre>{{selectedObservation | json}}</pre>
                                </div>
                            </div>

                        </uib-tab>



                        <uib-tab ng-show = "false" heading="Table">

                            <div class="row" style="margin-top: 8px"  ng-repeat = "entry in fhir.entry">
                                <div class="col-md-3">

                                    <span class = "resourceType"> {{entry.resource.resourceType}}</span>
                                </div>

                            </div>


                        </uib-tab>


                        <uib-tab heading="Json">
                            <div>
                                <pre ng-show="fhir">  {{fhir | json}} </pre>

                            </div>
                        </uib-tab>





                    </uib-tabset>





        </div>



    </div>












</div>
</body>
</html>